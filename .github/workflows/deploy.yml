name: Deploy with Docker

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Create .env.local file from Secrets
        run: |
          echo "NEXT_PUBLIC_SPRINGBOOT_URL=${{ secrets.NEXT_PUBLIC_SPRINGBOOT_URL }}" >> .env.local
          echo "NEXT_PUBLIC_S3_URL=${{ secrets.NEXT_PUBLIC_S3_URL }}" >> .env.local
          echo "NEXT_PUBLIC_WEBSOCKET_URL=${{ secrets.NEXT_PUBLIC_WEBSOCKET_URL }}" >> .env.local

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          docker build --no-cache -t seuo/wannago-fe-image:latest .
          docker push seuo/wannago-fe-image:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH Key
        run: |
          echo "${{ secrets.PEM_KEY }}" | base64 --decode > private-key.pem
          chmod 600 private-key.pem

      - name: Deploy to Server using docker-compose and NGINX
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key_path: private-key.pem
          script: |
            cd ~/wannago-deploy || mkdir ~/wannago-deploy && cd ~/wannago-deploy

            # ìµœì‹  í”„ë¡ íŠ¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            docker pull seuo/wannago-fe-image:latest

            # docker-compose.yml ìƒì„± (ğŸ†• nginx í¬í•¨)
            cat <<EOF > docker-compose.yml
            version: '3'
            services:
              frontend:
                image: seuo/wannago-fe-image:latest
                container_name: wannago_fe
                restart: always
                expose:
                  - "3000" # nginxê°€ ë‚´ë¶€ì—ì„œ ì ‘ê·¼í•  í¬íŠ¸

              nginx:
                image: nginx:latest
                container_name: nginx-proxy
                restart: always
                ports:
                  - "80:80"
                volumes:
                  - ./nginx.conf:/etc/nginx/nginx.conf:ro
                depends_on:
                  - frontend
            EOF

            # nginx.conf ìƒì„± (ğŸ†• ê¸°ë³¸ reverse proxy ì„¤ì •)
            cat <<EOF > nginx.conf
            events {}
            http {
              server {
                listen 80;
                location / {
                  proxy_pass http://frontend:3000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                }
              }
            }
            EOF

            docker compose down
            docker compose up -d
